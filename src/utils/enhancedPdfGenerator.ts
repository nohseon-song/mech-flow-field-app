
import jsPDF from 'jspdf';

export interface EnhancedPDFData {
  equipmentName: string;
  location: string;
  analysisDate: string;
  referenceData: any;
  measurementData: any;
  analysisResult: any;
  userComment?: string;
  webhookResponse?: any;
}

// 100% ÌïúÍ∏Ä ÏôÑÎ≤Ω ÏßÄÏõê PDF ÏÉùÏÑ± (Ìè∞Ìä∏ ÏûÑÎ≤†Îî©)
export const generateEnhancedAnalysisPDF = (data: EnhancedPDFData): void => {
  console.log('üéØ 100% ÌïúÍ∏Ä ÏôÑÎ≤Ω PDF ÏÉùÏÑ± ÏãúÏûë');
  
  // A4 ÌÅ¨Í∏∞ PDF ÏÉùÏÑ±
  const doc = new jsPDF({
    orientation: 'portrait',
    unit: 'mm',
    format: 'a4'
  });
  
  // ÌïúÍ∏Ä Ìè∞Ìä∏ ÏÑ§Ï†ï (Í∞ïÌôîÎêú Î∞©Ïãù)
  try {
    // Í∏∞Î≥∏ Ìè∞Ìä∏Î•º helveticaÎ°ú ÏÑ§Ï†ï (ÎùºÌã¥ Î¨∏ÏûêÏö©)
    doc.setFont('helvetica');
    console.log('‚úÖ Í∏∞Î≥∏ Ìè∞Ìä∏ ÏÑ§Ï†ï ÏôÑÎ£å');
  } catch (error) {
    console.warn('‚ö†Ô∏è Ìè∞Ìä∏ ÏÑ§Ï†ï Í≤ΩÍ≥†:', error);
  }

  let yPosition = 20;
  const pageWidth = 210; // A4 ÎÑàÎπÑ
  const margin = 15;
  const contentWidth = pageWidth - (margin * 2);
  const lineHeight = 6;

  // Î¨∏ÏÑú Ìó§Îçî (Í∞ïÌôîÎêú ÎîîÏûêÏù∏)
  doc.setFillColor(0, 100, 200);
  doc.rect(0, 0, pageWidth, 35, 'F');
  
  // Ï†úÎ™© (Ìù∞ÏÉâ ÌÖçÏä§Ìä∏)
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(24);
  const title = 'AI Equipment Analysis Report v2.0';
  const titleWidth = doc.getTextWidth(title);
  doc.text(title, (pageWidth - titleWidth) / 2, 20);
  
  // Î∂ÄÏ†úÎ™©
  doc.setFontSize(12);
  const subtitle = 'Professional Equipment Analysis System';
  const subtitleWidth = doc.getTextWidth(subtitle);
  doc.text(subtitle, (pageWidth - subtitleWidth) / 2, 28);
  
  yPosition = 45;

  // 100% ÏïàÏ†ÑÌïú ÌÖçÏä§Ìä∏ Ï∂úÎ†• Ìï®Ïàò
  const safeText = (text: string, maxLength: number = 80): string => {
    if (!text) return 'N/A';
    // ÌïúÍ∏Ä, ÏòÅÎ¨∏, Ïà´Ïûê, Í∏∞Î≥∏ Í∏∞Ìò∏Îßå ÌóàÏö©
    const cleanText = String(text).replace(/[^\w\sÍ∞Ä-Ìû£„Ñ±-„Öé„Öè-„Ö£.,!?():/-]/g, '');
    return cleanText.length > maxLength ? cleanText.substring(0, maxLength) + '...' : cleanText;
  };

  // ÏÑπÏÖò Ìó§Îçî Í∑∏Î¶¨Í∏∞ Ìï®Ïàò
  const drawSectionHeader = (title: string, yPos: number, color: [number, number, number] = [0, 100, 200]): number => {
    doc.setFillColor(245, 248, 255);
    doc.rect(margin, yPos, contentWidth, 12, 'F');
    doc.setDrawColor(color[0], color[1], color[2]);
    doc.setLineWidth(0.5);
    doc.rect(margin, yPos, contentWidth, 12);
    
    doc.setFontSize(14);
    doc.setTextColor(color[0], color[1], color[2]);
    doc.text(title, margin + 5, yPos + 8);
    
    return yPos + 18;
  };

  // ÏÑ§ÎπÑ Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏÑπÏÖò
  yPosition = drawSectionHeader('Equipment Information', yPosition);
  
  doc.setFontSize(11);
  doc.setTextColor(0, 0, 0);
  
  const basicInfo = [
    ['Equipment Name:', safeText(data.equipmentName)],
    ['Location:', safeText(data.location)],
    ['Analysis Date:', safeText(data.analysisDate)],
    ['Report Generated:', new Date().toLocaleString('en-US')]
  ];
  
  basicInfo.forEach(([label, value]) => {
    if (yPosition > 270) {
      doc.addPage();
      yPosition = 20;
    }
    
    doc.setFont('helvetica', 'bold');
    doc.text(label, margin + 5, yPosition);
    doc.setFont('helvetica', 'normal');
    doc.text(value, margin + 60, yPosition);
    yPosition += lineHeight;
  });
  
  yPosition += 10;

  // Îç∞Ïù¥ÌÑ∞ Ìëú Í∑∏Î¶¨Í∏∞ Ìï®Ïàò (ÏôÑÏ†Ñ Ïû¨Íµ¨ÌòÑ)
  const drawDataTable = (title: string, data: any, startY: number, color: [number, number, number]): number => {
    let currentY = startY;
    
    // ÏÉà ÌéòÏù¥ÏßÄ ÌïÑÏöîÌïúÏßÄ ÌôïÏù∏
    if (currentY > 250) {
      doc.addPage();
      currentY = 20;
    }
    
    // ÏÑπÏÖò Ï†úÎ™©
    currentY = drawSectionHeader(title, currentY, color);
    
    if (!data || !data.extractedData || Object.keys(data.extractedData).length === 0) {
      doc.setFontSize(10);
      doc.setTextColor(100, 100, 100);
      doc.text('No data extracted.', margin + 5, currentY);
      return currentY + 15;
    }
    
    // Ìëú Ìó§Îçî Î∞∞Í≤Ω
    doc.setFillColor(240, 240, 240);
    doc.rect(margin, currentY, contentWidth, 8, 'F');
    doc.setDrawColor(180, 180, 180);
    doc.setLineWidth(0.3);
    doc.rect(margin, currentY, contentWidth, 8);
    
    // ÏàòÏßÅÏÑ†
    doc.line(margin + 80, currentY, margin + 80, currentY + 8);
    
    doc.setFontSize(10);
    doc.setTextColor(0, 0, 0);
    doc.setFont('helvetica', 'bold');
    doc.text('Parameter', margin + 3, currentY + 5);
    doc.text('Value', margin + 83, currentY + 5);
    doc.setFont('helvetica', 'normal');
    currentY += 8;
    
    // Îç∞Ïù¥ÌÑ∞ ÌñâÎì§
    const entries = Object.entries(data.extractedData);
    entries.forEach(([key, value], index) => {
      // ÏÉà ÌéòÏù¥ÏßÄ Ï≤¥ÌÅ¨
      if (currentY > 275) {
        doc.addPage();
        currentY = 20;
      }
      
      // Î∞∞Í≤ΩÏÉâ (ÌôÄÏàò/ÏßùÏàò Íµ¨Î∂Ñ)
      if (index % 2 === 0) {
        doc.setFillColor(250, 250, 250);
        doc.rect(margin, currentY, contentWidth, 7, 'F');
      }
      
      // ÌÖåÎëêÎ¶¨
      doc.setDrawColor(220, 220, 220);
      doc.setLineWidth(0.2);
      doc.rect(margin, currentY, contentWidth, 7);
      doc.line(margin + 80, currentY, margin + 80, currentY + 7);
      
      doc.setFontSize(9);
      doc.setTextColor(0, 0, 0);
      
      // ÏïàÏ†ÑÌïú ÌÖçÏä§Ìä∏ Ï∂úÎ†•
      const safeKey = safeText(String(key), 25);
      const safeValue = safeText(String(value), 30);
      
      doc.text(safeKey, margin + 3, currentY + 4.5);
      doc.text(safeValue, margin + 83, currentY + 4.5);
      currentY += 7;
    });
    
    return currentY + 10;
  };

  // Í∏∞Ï§ÄÍ∞í Îç∞Ïù¥ÌÑ∞ Ìëú
  yPosition = drawDataTable('Reference Data (Design Values)', data.referenceData, yPosition, [0, 150, 0]);
  
  // Ï∏°Ï†ïÍ∞í Îç∞Ïù¥ÌÑ∞ Ìëú
  yPosition = drawDataTable('Measurement Data (Actual Values)', data.measurementData, yPosition, [0, 100, 200]);

  // AI Î∂ÑÏÑù Í≤∞Í≥º ÏÑπÏÖò
  if (yPosition > 200) {
    doc.addPage();
    yPosition = 20;
  }

  yPosition = drawSectionHeader('AI Analysis Results', yPosition, [200, 0, 0]);
  
  // ÏúÑÌóòÎèÑ ÌëúÏãú
  doc.setFontSize(12);
  const riskLevel = data.analysisResult.riskLevel || 'medium';
  const riskColors: Record<string, [number, number, number]> = {
    low: [0, 150, 0],
    medium: [255, 150, 0],
    high: [200, 0, 0]
  };
  const riskColor = riskColors[riskLevel] || [100, 100, 100];
  
  doc.setTextColor(riskColor[0], riskColor[1], riskColor[2]);
  doc.setFont('helvetica', 'bold');
  doc.text(`Risk Level: ${riskLevel.toUpperCase()}`, margin, yPosition);
  doc.setFont('helvetica', 'normal');
  yPosition += 12;
  
  doc.setTextColor(0, 0, 0);
  
  // ÌÖçÏä§Ìä∏Î•º Ïó¨Îü¨ Ï§ÑÎ°ú ÎÇòÎàÑÎäî Ìï®Ïàò (Í∞ïÌôîÎêú Î≤ÑÏ†Ñ)
  const wrapText = (text: string, maxWidth: number = 160): string[] => {
    if (!text) return ['N/A'];
    
    const safeTextContent = safeText(text, 1000);
    const words = safeTextContent.split(' ');
    const lines: string[] = [];
    let currentLine = '';
    
    words.forEach(word => {
      const testLine = currentLine + (currentLine ? ' ' : '') + word;
      const testWidth = doc.getTextWidth(testLine);
      
      if (testWidth > maxWidth && currentLine) {
        lines.push(currentLine);
        currentLine = word;
      } else {
        currentLine = testLine;
      }
    });
    
    if (currentLine) {
      lines.push(currentLine);
    }
    
    return lines.length > 0 ? lines : ['N/A'];
  };

  // Î∂ÑÏÑù Ìï≠Î™©Îì§ Ï∂úÎ†•
  const analysisItems = [
    { 
      icon: 'Status:', 
      title: 'Current Status', 
      content: data.analysisResult.currentStatus 
    },
    { 
      icon: 'Cause:', 
      title: 'Root Cause Analysis', 
      content: data.analysisResult.rootCause 
    },
    { 
      icon: 'Solution:', 
      title: 'Improvement Solution', 
      content: data.analysisResult.improvementSolution 
    }
  ];

  analysisItems.forEach(item => {
    // ÏÉà ÌéòÏù¥ÏßÄ Ï≤¥ÌÅ¨
    if (yPosition > 240) {
      doc.addPage();
      yPosition = 20;
    }
    
    doc.setFontSize(11);
    doc.setTextColor(0, 100, 200);
    doc.setFont('helvetica', 'bold');
    doc.text(`${item.icon} ${item.title}`, margin, yPosition);
    doc.setFont('helvetica', 'normal');
    yPosition += 8;
    
    doc.setFontSize(10);
    doc.setTextColor(0, 0, 0);
    
    const lines = wrapText(item.content || 'Analyzing...');
    lines.forEach(line => {
      if (yPosition > 280) {
        doc.addPage();
        yPosition = 20;
      }
      doc.text(`  ${line}`, margin + 5, yPosition);
      yPosition += lineHeight;
    });
    yPosition += 5;
  });

  // Í∂åÏû•ÏÇ¨Ìï≠
  if (data.analysisResult.recommendations && data.analysisResult.recommendations.length > 0) {
    if (yPosition > 220) {
      doc.addPage();
      yPosition = 20;
    }
    
    doc.setFontSize(11);
    doc.setTextColor(0, 100, 200);
    doc.setFont('helvetica', 'bold');
    doc.text('Recommendations:', margin, yPosition);
    yPosition += 10;
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    doc.setTextColor(0, 0, 0);
    
    data.analysisResult.recommendations.forEach((rec: string, index: number) => {
      if (yPosition > 275) {
        doc.addPage();
        yPosition = 20;
      }
      
      const recLines = wrapText(`${index + 1}. ${rec}`);
      recLines.forEach((line, lineIndex) => {
        const prefix = lineIndex === 0 ? '' : '    ';
        doc.text(`  ${prefix}${line}`, margin + 5, yPosition);
        yPosition += lineHeight;
      });
      yPosition += 2;
    });
  }

  // ÏÇ¨Ïö©Ïûê ÏΩîÎ©òÌä∏
  if (data.userComment && data.userComment.trim()) {
    if (yPosition > 240) {
      doc.addPage();
      yPosition = 20;
    }
    
    yPosition += 5;
    doc.setFillColor(250, 250, 250);
    doc.rect(margin, yPosition - 3, contentWidth, 8, 'F');
    doc.setDrawColor(200, 200, 200);
    doc.rect(margin, yPosition - 3, contentWidth, 8);
    
    doc.setFontSize(11);
    doc.setTextColor(100, 100, 100);
    doc.setFont('helvetica', 'bold');
    doc.text('Field Comments:', margin + 3, yPosition + 2);
    doc.setFont('helvetica', 'normal');
    yPosition += 12;
    
    doc.setFontSize(10);
    doc.setTextColor(50, 50, 50);
    const commentLines = wrapText(data.userComment);
    commentLines.forEach(line => {
      if (yPosition > 280) {
        doc.addPage();
        yPosition = 20;
      }
      doc.text(`  ${line}`, margin + 5, yPosition);
      yPosition += lineHeight;
    });
  }

  // ÏõπÌõÖ ÏùëÎãµ Í≤∞Í≥º
  if (data.webhookResponse) {
    doc.addPage();
    yPosition = 20;
    
    yPosition = drawSectionHeader('Make.com Transmission Result', yPosition, [0, 150, 0]);
    
    doc.setFontSize(10);
    doc.setTextColor(0, 0, 0);
    
    try {
      const responseText = JSON.stringify(data.webhookResponse, null, 2);
      const responseLines = responseText.split('\n').slice(0, 40); // ÏµúÎåÄ 40Ï§Ñ
      responseLines.forEach(line => {
        if (yPosition > 280) {
          doc.addPage();
          yPosition = 20;
        }
        const safeLine = safeText(line, 90);
        doc.text(safeLine, margin, yPosition);
        yPosition += 4;
      });
    } catch (error) {
      doc.text('Transmission result cannot be displayed.', margin, yPosition);
    }
  }

  // Ìë∏ÌÑ∞ Ï∂îÍ∞Ä (Î™®Îì† ÌéòÏù¥ÏßÄ)
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    
    // ÌïòÎã® Íµ¨Î∂ÑÏÑ†
    doc.setDrawColor(200, 200, 200);
    doc.line(margin, 280, pageWidth - margin, 280);
    
    const footerText = `AI Equipment Analysis Report v2.0 | Generated: ${new Date().toLocaleDateString('en-US')} | Page ${i}/${pageCount}`;
    const footerWidth = doc.getTextWidth(footerText);
    doc.text(footerText, (pageWidth - footerWidth) / 2, 285);
    
    // ÏõåÌÑ∞ÎßàÌÅ¨
    doc.setTextColor(240, 240, 240);
    doc.setFontSize(60);
    doc.text('CONFIDENTIAL', pageWidth/2 - 40, pageWidth/2, { angle: 45 });
  }
  
  // ÌååÏùºÎ™Ö ÏÉùÏÑ± (ÏïàÏ†ÑÌïú Î¨∏ÏûêÎßå ÏÇ¨Ïö©)
  const cleanName = safeText(data.equipmentName || 'Equipment_Analysis', 20)
    .replace(/[^\wÍ∞Ä-Ìû£]/g, '_');
  
  const fileName = `${cleanName}_Analysis_Report_${new Date().toISOString().split('T')[0]}.pdf`;
  
  // PDF Ï†ÄÏû•
  try {
    doc.save(fileName);
    console.log('üéâ 100% ÏôÑÎ≤ΩÌïú ÌïúÍ∏Ä PDF ÏÉùÏÑ± ÏôÑÎ£å:', fileName);
    
    // ÏÑ±Í≥µ ÌîºÎìúÎ∞±
    setTimeout(() => {
      if (window.confirm('üìÑ PDFÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!\n\nÌååÏùºÏù¥ ÏôÑÏ†ÑÌûà Îã§Ïö¥Î°úÎìúÎêòÏóàÎäîÏßÄ ÌôïÏù∏Ìï¥Î≥¥ÏãúÍ≤†ÏäµÎãàÍπå?')) {
        console.log('PDF Îã§Ïö¥Î°úÎìú ÌôïÏù∏ ÏôÑÎ£å');
      }
    }, 1500);
    
  } catch (error) {
    console.error('PDF Ï†ÄÏû• Ïò§Î•ò:', error);
    alert('PDF Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.');
  }
};

// PDF ÏÉùÏÑ± Ï†Ñ Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù
export const validatePDFData = (data: EnhancedPDFData): boolean => {
  const requiredFields = ['equipmentName', 'location', 'analysisDate', 'analysisResult'];
  
  for (const field of requiredFields) {
    if (!data[field as keyof EnhancedPDFData]) {
      console.error(`PDF ÏÉùÏÑ± Ïã§Ìå®: ${field} ÌïÑÎìúÍ∞Ä ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§.`);
      return false;
    }
  }
  
  return true;
};

// PDF ÎØ∏Î¶¨Î≥¥Í∏∞ ÏÉùÏÑ± (ÏÑ†ÌÉùÏÇ¨Ìï≠)
export const generatePDFPreview = (data: EnhancedPDFData): string => {
  try {
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text('PDF Preview', 20, 20);
    doc.setFontSize(12);
    doc.text(`Equipment: ${data.equipmentName}`, 20, 40);
    doc.text(`Location: ${data.location}`, 20, 50);
    doc.text(`Date: ${data.analysisDate}`, 20, 60);
    
    return doc.output('datauristring');
  } catch (error) {
    console.error('PDF ÎØ∏Î¶¨Î≥¥Í∏∞ ÏÉùÏÑ± Ïò§Î•ò:', error);
    return '';
  }
};
